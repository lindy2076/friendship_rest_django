# Это маленький rest сервис на django ninja

Сервис предоставляет небольшой функционал: можно зарегестрироваться, авторизоваться и добавлять в друзья других пользователей.

Сервис написан на django ninja, тесты на pytest (покрытие 95%).

**API** расписан в файлах `openapi.json` и `openapi.yaml`.

## Гайд по установке

1. склонировать репозиторий
2. `python3 -m venv venv` - создать виртуальное окружение
3. `source venv/bin/activate` - активировать виртуальное окружение
4. создать файл `.env` и вставить в него данные из `.env.sample` (конечно, предварительно отредактировав)
5. `pip3 install -r friendship/requirements.txt` - установить необходимые библиотеки.
6. `make build` - собрать докер образы приложения, админки и бд.
7. `docker exec -it web /bin/bash` - зайти в контейнер с приложением
8. `python3 manage.py makemigrations` - зафиксировать миграции
9. `python3 manage.py migrate` - применить миграции
10. `python3 manage.py createsuperuser` - создать админа (далее следовать инструкциям джанги)
11. `exit` - выйти из контейнера.
12. перейти по `127.0.0.1:8000/api/v1/docs` - откроется страница с документацией openapi.
13. пользоваться сервисом


## Как менять код
1. выполнить шаги по установке
2. поменять код
3. поднять базу локально (см. параграф ниже).
4. `make lint` - проверить код линтером (flake8)
5. `make tests` - прогнать тесты (pytest)
6. `make build` - обновить докер образы.


## Как менять код без мучений
1. выполнить шаги по установке
2. в файле `docker-compose.yml` закомментировать образ приложения `web`.
3. у сервиса `db` раскомментировать порты
4. в настройках джанги `friendship/friendship/settings.py` у словаря 'default' списка `DATABASES` раскомментировать `'HOST': localhost'` и закомментировать `'HOST': os.environ.get('DB_HOST')`.
5. `make build` - собрать образ базы данных и её админки.
6. `make run` - запустить приложение.
7. `localhost:8080/` - адрес приложения, можно менять код и видеть результат мгновенно
8. `localhost:8081/` - адрес админки, там можно данные в бд смотреть.
9. когда сделали какой-то апдейт, то `make lint` и `make tests`.
10. обратно закомментировать и расскоментировать что закомментировали и раскомментировали.
11. `make build`
12. profit

## Как останавливать и запускать сервис
1. `make down` - остановить, если сервис запущен
2. `make up` - запустить, если сервис остановлен
3. `make build` - пересобрать docker образы. 

## Краткий функционал

`/api/v1/docs` - openapi документация. Далее описана часть функционала.

**User** в сервисе имеет поля uuid, username, password, date_created, is_staff.

#### функционал, связанный с юзерами
- `/api/v1/users/` - получить всех юзеров сервиса

#### функционал, связанный с авторизацией/регистрацией
- `/api/v1/register` - регистрация по username и password. Если ник не занят, то регистрируется новый юзер. Username может содержать только латинские буквы и цифры
- `/api/v1/login` - авторизация по username и password. Вовзращается токен, который живёт по умолчанию 10 минут. Его нужно отправлять в хедере (`'HTTP_AUTHORIZATION': 'Bearer token.example'`) (в сваггере можно авторизоваться и не мучаться с хедерами)
- `/api/v1/whoami` - возвращает username и uuid авторизованного пользователя.

#### функционал, связанный с дружбой (требуется авторизация)
- `/api/v1/friends/myfriends` - получить список своих друзей
- `/api/v1/friends/requests` - получить список исходящих и входящих заявок
- `/api/v1/friends/{user_id}/status` - получить статус дружбы с юзером по его user_id. Есть 4 статуса: **none**, **outgoing**, **incoming**, **friends**.
- `/api/v1/friends/{user_id}/add` - добавить юзера в друзья по его user_id. Если от этого юзера есть заявка в друзья, то статус дружбы с ним сменится с **incoming** на **friends**.
- `/api/v1/friends/{user_id}/remove` - удалить юзера из друзей / отменить заявку в друзья. Если юзер1 отправил заявку юзеру2, и юзер2 принял заявку, а потом юзер1 удалил юзера2 из друзей, то статус дружбы становится **none**. Если юзер1 отправил заявку юзеру2, и юзер2 принял заявку, а затем юзер2 передумал и удалил юзера1 из друзей, то заявка в друзья от юзера1 не удалится. Таким образом, накручивать подписчиков (входящие заявки) не получится.

